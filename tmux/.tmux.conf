# =============================
#  Tmux Configuration (2025)
#  Optimized for performance & UX
#  Updated with latest best practices
# =============================

### Prefix & Key Bindings ###
## Set prefix to C-a (unbind default C-b) and enable sending prefix
unbind C-b
set -g prefix C-a
bind-key C-a send-prefix
# Send prefix key to underlying application
bind-key a send-prefix

# --- Plugins & Extensions ---
# List of plugins using TPM (keep TPM as the first plugin)
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
# Additional plugins for enhanced UX
set -g @plugin 'tmux-plugins/tmux-open'

# Configure tmux-open for Command+Click link following
set -g @open-S 'https://www.google.com/search?q='
set -g @plugin 'tmux-plugins/tmux-pain-control'
set -g @plugin 'tmux-plugins/tmux-sessionist'
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'tmux-plugins/tmux-yank'

## Use vi keys in copy mode
setw -g mode-keys vi


## Enhanced copy mode with modern vi-style bindings
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"

# Modern copy mode mouse behavior (2025 best practices)
bind -T copy-mode MouseDragEnd1Pane send-keys -X copy-selection-no-clear
unbind -T copy-mode MouseDragEnd1Pane

# Command+Click to open links (tmux-open plugin)
bind -T root MouseDown2Pane run-shell "tmux-open -l"

## Set escape time to 1ms for better responsiveness with modern terminals
set -s escape-time 1

## Enable xterm-keys for better terminal compatibility with Ghostty and other modern terminals
set -g xterm-keys on

## Mouse support for modern workflows (early placement for better organization)
set -g mouse on
unbind -Troot MouseDown1Status  # Prevent accidental window switching
bind -Troot DoubleClick1Status resize-p -Zt=  # Double-click to zoom pane

## Additional terminal overrides for improved compatibility with Ghostty and modern terminals
set -as terminal-overrides ',*:U8=0'  # Enable Unicode handling
set -as terminal-overrides 'xterm*:smcup@:rmcup@'  # Fix alternate screen issues
set -ga terminal-overrides ',xterm-256color:RGB'  # Enhanced RGB color support
set -ga terminal-overrides ',*:U9=0'  # Unicode 9 for better emoji/symbol handling

# --- Windows & Panes ---
## Start window and pane numbering at 1 and renumber windows automatically
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

## Performance: Optimize scrollback buffer for memory efficiency
set -g history-limit 25000
set -g display-panes-time 300
set -g display-time 300
# Set status interval to 10 seconds to save CPU (optimized for performance)
set -g status-interval 10
# Reduce repeat time for faster pane switching
set -g repeat-time 200

# --- Activity & Auto Rename ---
setw -g monitor-activity on
set -g visual-activity on

## Auto-rename window based on the current pane's path
# status-interval is set above
set-option -g automatic-rename on
set-option -g automatic-rename-format '#{b:pane_current_path}'

# --- Appearance ---
## Enable true color and italic fonts
set -g default-terminal "tmux-256color"

# --- UX Shortcuts & Macros ---
# Quick pane switching (prefix + h/j/k/l)
set-option -ga terminal-overrides ",xterm-256color:Tc"
set -as terminal-overrides ',xterm*:sitm=\E[3m'

## Theme Plugin: Catppuccin with modern settings
set -g @plugin 'catppuccin/tmux'
set -g @catppuccin_flavor 'mocha'
set -g @catppuccin_window_middle_separator " "
set -g @catppuccin_window_number_position "right"
set -g @catppuccin_window_default_fill "number"
set -g @catppuccin_window_current_fill "number"

# Streamlined status bar configuration
set -g status-left-length 30
set -g status-right-length 100
set -g status-left "#{?client_prefix,#[fg=orange]âŒ¨ ,}#S"
set -g status-right "#{E:@catppuccin_status_application}"

# --- Resurrect Configuration (Updated with 2025 best practices) ---
# Modern resurrect strategy for better performance (macOS optimized)
set -g @resurrect-save-command-strategy 'pgrep'
set -g @resurrect-delete-backup-after '30'

# Enhanced process restoration for modern workflows
set -g @resurrect-processes 'ssh "~yarn watch" "~yarn dev" "~yarn test"'
set -g @resurrect-hook-pre-restore-pane-processes 'pkill -f "yarn.*"'

# Vim/Neovim session restoration
set -g @resurrect-strategy-vim 'session'
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-pane-contents-area 'visible'
set -g @resurrect-dir '~/tmux-resurrect'

# --- Enhanced Keybindings & Workflow ---
## Bind R (with prefix) to reload this configuration
bind R source-file ~/.tmux.conf \; display-message "tmux.conf Reloaded!"
## Bind ? to show key bindings help
bind ? list-keys

# Enhanced session management
bind-key C-s choose-session -F "#{session_name}: #{window_count} windows"
bind-key S command-prompt -p "New session name:" "new-session -s '%%'"

# Window/pane management with confirmation
bind x confirm-before -p 'Kill pane? (y/n)' 'kill-pane'
bind X confirm-before -p 'Kill window? (y/n)' 'kill-window'

# Keybindings:
# prefix + w => fuzzy-switch window/pane across all sessions
# These call the helper scripts shipped with the plugin. They run in background (-b)
bind-key w run-shell -b "~/.tmux/plugins/tmux-fzf/scripts/window.sh switch"

# --- Modern Performance Optimizations ---

# Better mouse wheel handling for scroll and navigation
bind -n WheelUpPane if -F '#{||:#{pane_in_mode},#{mouse_any_flag}}' \
   'send -M' 'if -F "#{alternate_on}" "send-keys -N 3 Up" "copy-mode -e"'
bind -n WheelDownPane if -F '#{||:#{pane_in_mode},#{mouse_any_flag}}' \
   'send -M' 'if -F "#{alternate_on}" "send-keys -N 3 Down"'

# Enhanced terminal integration (2025 optimizations)
set -g focus-events on
set -g allow-passthrough on

# Optimize for large terminals
set -g aggressive-resize on

# --- Initialize TPM ---
run '~/.tmux/plugins/tpm/tpm'
